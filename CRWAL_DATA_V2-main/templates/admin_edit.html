{% extends "base.html" %}

{% block title %}Ch·ªânh s·ª≠a: {{ title }} - WikiNongSan{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Ch·ªânh s·ª≠a: {{ title }}</h1>
    <div class="admin-actions">
        <a href="/page/{{ slug }}" class="btn btn-secondary">Xem trang</a>
        <a href="/admin/dashboard" class="btn btn-secondary">‚Üê Dashboard</a>
    </div>
</div>

<div class="admin-content">
    <form action="/admin/edit/{{ slug }}" method="post" class="page-form">
        <div class="form-group">
            <label for="content">N·ªôi dung (Markdown):</label>
            <textarea id="content" name="content" required class="form-textarea" rows="25">{{ content }}</textarea>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
            <a href="/page/{{ slug }}" class="btn btn-secondary">H·ªßy</a>
        </div>
    </form>
    
    <div class="edit-info">
        <h3>Th√¥ng tin trang</h3>
        <ul>
            <li><strong>Slug:</strong> {{ slug }}</li>
            <li><strong>URL:</strong> <a href="/page/{{ slug }}" target="_blank">/page/{{ slug }}</a></li>
            <li><strong>File:</strong> pages/{{ slug }}.md</li>
        </ul>
        
        <h4>L∆∞u √Ω:</h4>
        <ul>
            <li>S·ª≠ d·ª•ng c√∫ ph√°p Markdown ƒë·ªÉ ƒë·ªãnh d·∫°ng</li>
            <li>Thay ƒë·ªïi s·∫Ω c√≥ hi·ªáu l·ª±c ngay l·∫≠p t·ª©c</li>
            <li>H√£y ki·ªÉm tra k·ªπ tr∆∞·ªõc khi l∆∞u</li>
        </ul>
        
        <h3>üñºÔ∏è Qu·∫£n l√Ω ·∫£nh b√†i vi·∫øt</h3>
        <p>Upload ·∫£nh ri√™ng cho b√†i vi·∫øt n√†y (hi·ªÉn th·ªã trong sidebar)</p>
        <form id="imageUploadForm" enctype="multipart/form-data" class="image-upload-form">
            <div class="form-group">
                <label for="imageFile">Ch·ªçn ·∫£nh:</label>
                <input type="file" id="imageFile" accept="image/*" class="form-input">
            </div>
            <button type="submit" class="btn btn-primary">üì§ Upload ·∫£nh b√†i vi·∫øt</button>
        </form>
        <div id="uploadResult" class="upload-result"></div>
        
        <div class="current-image">
            <h4>·∫¢nh hi·ªán t·∫°i:</h4>
            <div class="image-preview">
                <img id="currentSidebarImg" src="/static/uploads/{{ slug }}.jpg" alt="·∫¢nh b√†i vi·∫øt hi·ªán t·∫°i" 
                     style="max-width: 200px; max-height: 200px; width: auto; height: auto; object-fit: cover; border-radius: 8px; margin-top: 0.5rem;"
                     onerror="this.style.display='none'; document.getElementById('noCurrentImage').style.display='block';">
                <p id="noCurrentImage" style="display: none; color: #666; font-style: italic;">Ch∆∞a c√≥ ·∫£nh cho b√†i vi·∫øt n√†y</p>
            </div>
            <div class="image-actions" style="margin-top: 1rem;">
                <button id="deleteImageBtn" class="btn btn-danger btn-small" onclick="deleteImage()">
                    üóëÔ∏è X√≥a ·∫£nh
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-save draft m·ªói 30 gi√¢y
let autoSaveTimer;
const textarea = document.getElementById('content');

textarea.addEventListener('input', function() {
    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(function() {
        localStorage.setItem('draft_{{ slug }}', textarea.value);

    }, 30000);
});

// Kh√¥i ph·ª•c draft khi load trang
window.addEventListener('load', function() {
    const draft = localStorage.getItem('draft_{{ slug }}');
    if (draft && confirm('C√≥ b·∫£n nh√°p ƒë∆∞·ª£c l∆∞u. B·∫°n c√≥ mu·ªën kh√¥i ph·ª•c?')) {
        textarea.value = draft;
    }
});

// X√≥a draft khi submit
document.querySelector('.page-form').addEventListener('submit', function() {
    localStorage.removeItem('draft_{{ slug }}');
});

// Image upload form handler
document.addEventListener('DOMContentLoaded', function() {
    const imageForm = document.getElementById('imageUploadForm');
    if (imageForm) {
        imageForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('imageFile');
    const resultDiv = document.getElementById('uploadResult');
    
    if (!fileInput.files[0]) {
        resultDiv.innerHTML = '<p style="color: #dc3545;">Vui l√≤ng ch·ªçn file ·∫£nh!</p>';
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('slug', '{{ slug }}');
    
    resultDiv.innerHTML = '<p style="color: #007bff;">‚è≥ ƒêang upload...</p>';
    
    try {
        const response = await fetch('/admin/api/upload-image', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            resultDiv.innerHTML = `<p style="color: #28a745;">‚úÖ ${result.message}</p>`;
            fileInput.value = ''; // Clear file input
            
            // C·∫≠p nh·∫≠t ·∫£nh preview
            const currentImg = document.getElementById('currentSidebarImg');
            const noImageText = document.getElementById('noCurrentImage');
            currentImg.src = result.image_url + '?t=' + new Date().getTime(); // Cache bust
            currentImg.style.display = 'block';
            noImageText.style.display = 'none';
        } else {
            resultDiv.innerHTML = `<p style="color: #dc3545;">‚ùå ${result.error}</p>`;
        }
        
    } catch (error) {
        resultDiv.innerHTML = `<p style="color: #dc3545;">‚ùå L·ªói upload: ${error.message}</p>`;
    }
        });
    }
});

// Delete image function
async function deleteImage() {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh b√†i vi·∫øt n√†y?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('slug', '{{ slug }}');
    
    try {
        const response = await fetch('/admin/api/delete-image', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // ·∫®n ·∫£nh v√† hi·ªán text "ch∆∞a c√≥ ·∫£nh"
            const currentImg = document.getElementById('currentSidebarImg');
            const noImageText = document.getElementById('noCurrentImage');
            const uploadResult = document.getElementById('uploadResult');
            
            currentImg.style.display = 'none';
            noImageText.style.display = 'block';
            uploadResult.innerHTML = `<p style="color: #28a745;">‚úÖ ${result.message}</p>`;
        } else {
            document.getElementById('uploadResult').innerHTML = `<p style="color: #ffc107;">‚ö†Ô∏è ${result.message}</p>`;
        }
        
    } catch (error) {
        document.getElementById('uploadResult').innerHTML = `<p style="color: #dc3545;">‚ùå L·ªói x√≥a ·∫£nh: ${error.message}</p>`;
    }
}
</script>
{% endblock %}