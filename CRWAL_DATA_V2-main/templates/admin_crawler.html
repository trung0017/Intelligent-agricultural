{% extends "base.html" %}

{% block title %}Crawler & AI - WikiNongSan{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Crawler & AI Processing</h1>
    <div class="admin-actions">
        <a href="/admin/dashboard" class="btn btn-secondary">‚Üê Dashboard</a>
    </div>
</div>

<!-- System Status -->
<div class="system-status" id="systemStatus">
    <h2>Tr·∫°ng th√°i h·ªá th·ªëng</h2>
    <div class="status-grid">
        <div class="status-card" id="ollamaStatus">
            <h4>ü§ñ AI (Ollama)</h4>
            <p class="status-text">ƒêang ki·ªÉm tra...</p>
        </div>
    </div>
</div>

<!-- Multi-Source Crawler -->
<div class="crawler-section">
    <h2>üï∑Ô∏è Multi-Source Crawler</h2>
    <p>Thu th·∫≠p n·ªôi dung t·ª´ nhi·ªÅu trang web v√† t·ªïng h·ª£p th√†nh 1 b√†i vi·∫øt wiki</p>
    
    <form id="crawlerForm" class="crawler-form">
        <div class="form-group">
            <label for="topic">Ch·ªß ƒë·ªÅ b√†i vi·∫øt:</label>
            <input type="text" id="topic" name="topic" required class="form-input" 
                   placeholder="V√≠ d·ª•: K·ªπ thu·∫≠t tr·ªìng l√∫a hi·ªán ƒë·∫°i">
        </div>
        
        <div class="form-group">
            <label for="urls">URLs (1-5 URL, m·ªói URL m·ªôt d√≤ng):</label>
            <textarea id="urls" name="urls" required class="form-textarea" rows="8"
                      placeholder="https://vnexpress.net/...
https://dantri.com.vn/...
https://nongnghiep.vn/..."></textarea>
            <small>üí° Ch·ªçn c√°c b√†i vi·∫øt c√πng ch·ªß ƒë·ªÅ ƒë·ªÉ c√≥ k·∫øt qu·∫£ t·ªët nh·∫•t</small>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="startCrawlerBtn">
                 B·∫Øt ƒë·∫ßu thu th·∫≠p
            </button>
            <button type="button" class="btn btn-secondary" onclick="clearForm()">
                üóëÔ∏è X√≥a form
            </button>
        </div>
    </form>
</div>

<!-- Task Monitor -->
<div class="task-monitor" id="taskMonitor" style="display: none;">
    <h2>üìä Theo d√µi ti·∫øn tr√¨nh</h2>
    
    <div class="task-info">
        <p><strong>Task ID:</strong> <span id="currentTaskId">-</span></p>
        <p><strong>Tr·∫°ng th√°i:</strong> <span id="currentTaskStatus" class="status-badge">-</span></p>
    </div>
    
    <div class="task-logs">
        <h3>üìù Logs</h3>
        <div id="taskLogs" class="logs-container">
            <p>Ch∆∞a c√≥ logs...</p>
        </div>
    </div>
    
    <div class="task-actions">
        <button type="button" class="btn btn-secondary" onclick="hideTaskMonitor()">
            ‚ùå ƒê√≥ng
        </button>
        <button type="button" class="btn btn-primary" onclick="refreshLogs()">
            üîÑ Refresh
        </button>
    </div>
</div>

<!-- Text Cleaner -->
<div class="cleaner-section">
    <h2>ü§ñ Text Cleaner</h2>
    <p>L√†m s·∫°ch c√°c file JSON th√¥ trong th∆∞ m·ª•c raw_content v·ªõi AI prompt t√πy ch·ªânh</p>
    
    <form id="cleanerForm" class="cleaner-form">
        <div class="form-group">
            <label for="aiPrompt">üéØ AI Prompt (t√πy ch·ªânh):</label>
            <textarea id="aiPrompt" name="aiPrompt" class="form-textarea" rows="8" 
                      placeholder="Nh·∫≠p prompt t√πy ch·ªânh cho AI...">B·∫°n l√† chuy√™n gia vi·∫øt b√†i v·ªÅ n√¥ng nghi·ªáp. H√£y t·ªïng h·ª£p v√† vi·∫øt l·∫°i n·ªôi dung sau th√†nh m·ªôt b√†i vi·∫øt wiki ho√†n ch·ªânh.

Y√äU C·∫¶U:
1. T·∫°o m·ªôt b√†i vi·∫øt m·∫°ch l·∫°c, c√≥ c·∫•u tr√∫c r√µ r√†ng
2. Lo·∫°i b·ªè th√¥ng tin tr√πng l·∫∑p gi·ªØa c√°c ngu·ªìn
3. T·ªïng h·ª£p th√¥ng tin t·ª´ nhi·ªÅu ngu·ªìn th√†nh n·ªôi dung th·ªëng nh·∫•t
4. S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng Markdown v·ªõi ti√™u ƒë·ªÅ, danh s√°ch, b·∫£ng bi·ªÉu
5. Gi·ªØ l·∫°i th√¥ng tin quan tr·ªçng, lo·∫°i b·ªè qu·∫£ng c√°o
6. Vi·∫øt b·∫±ng ti·∫øng Vi·ªát, phong c√°ch wiki chuy√™n nghi·ªáp
7. Th√™m c√°c ph·∫ßn: Gi·ªõi thi·ªáu, N·ªôi dung ch√≠nh, K·∫øt lu·∫≠n

N·ªòI DUNG C·∫¶N X·ª¨ L√ù:
{content}

B√ÄI VI·∫æT WIKI HO√ÄN CH·ªàNH:</textarea>
            <small>üí° S·ª≠ d·ª•ng {content} ƒë·ªÉ ch√®n n·ªôi dung c·∫ßn x·ª≠ l√Ω. {topic} ƒë·ªÉ ch√®n ch·ªß ƒë·ªÅ.</small>
        </div>
        
        <div class="cleaner-actions">
            <button type="submit" class="btn btn-primary">
                ‚ú® L√†m s·∫°ch v·ªõi prompt t√πy ch·ªânh
            </button>
            <button type="button" class="btn btn-secondary" onclick="resetPrompt()">
                üîÑ Reset prompt m·∫∑c ƒë·ªãnh
            </button>
            <button type="button" class="btn btn-secondary" onclick="checkRawFiles()">
                üìÑ Ki·ªÉm tra file th√¥
            </button>
        </div>
    </form>
    
    <div id="cleanerResults" class="results-container" style="display: none;">
        <h3>K·∫øt qu·∫£</h3>
        <div id="cleanerOutput"></div>
    </div>
</div>



<!-- Quick Actions -->
<div class="quick-actions">
    <h2>‚ö° Thao t√°c nhanh</h2>
    <div class="actions-grid">
        <button class="action-btn" onclick="viewRawContent()">
            ÔøΩ  Xem file raw_content
        </button>
        <button class="action-btn" onclick="viewCleanedContent()">
            üìÅ Xem file cleaned_content
        </button>
        <button class="action-btn" onclick="viewAllPages()">
            ÔøΩ Xem  t·∫•t c·∫£ trang
        </button>
    </div>
</div>

<!-- File Viewer Modal -->
<div id="fileViewerModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Qu·∫£n l√Ω file</h3>
            <button class="modal-close" onclick="closeFileViewer()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="fileList" class="file-list">
                <!-- File list will be populated here -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeFileViewer()">ƒê√≥ng</button>
            <button id="deleteAllBtn" class="btn btn-danger" onclick="deleteAllFiles()" style="display: none;">
                üóëÔ∏è X√≥a t·∫•t c·∫£
            </button>
        </div>
    </div>
</div>

<style>
.system-status {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.status-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    margin-top: 1rem;
    max-width: 300px;
}

.status-card {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #2c5530;
}

.status-card h4 {
    margin-bottom: 0.5rem;
    color: #2c5530;
}

.status-text {
    margin: 0;
    font-size: 0.9rem;
}

.crawler-section, .cleaner-section {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.crawler-form, .cleaner-form {
    max-width: 600px;
}

.task-monitor {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    border: 2px solid #2c5530;
}

.task-info {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
}

.status-badge.running {
    background: #ffc107;
    color: #000;
}

.status-badge.completed {
    background: #28a745;
    color: white;
}

.status-badge.failed {
    background: #dc3545;
    color: white;
}

.logs-container {
    background: #000;
    color: #00ff00;
    padding: 1rem;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
}

.cleaner-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.results-container {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 5px;
    margin-top: 1rem;
}

.quick-actions {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.action-btn {
    background: #e9ecef;
    border: none;
    padding: 1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
    font-size: 0.9rem;
}

.action-btn:hover {
    background: #2c5530;
    color: white;
}

.danger-btn {
    background: #dc3545 !important;
    color: white !important;
}

.danger-btn:hover {
    background: #c82333 !important;
}

.loading {
    opacity: 0.6;
    pointer-events: none;
}

/* Modal styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 10px;
    width: 80%;
    max-width: 800px;
    max-height: 80vh;
    overflow: hidden;
}

.modal-header {
    background: #2c5530;
    color: white;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
}

.modal-body {
    padding: 1rem;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-footer {
    padding: 1rem;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.file-list {
    display: grid;
    gap: 0.5rem;
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 5px;
    border-left: 4px solid #2c5530;
}

.file-info {
    flex: 1;
}

.file-name {
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.file-meta {
    font-size: 0.8rem;
    color: #666;
}

.file-actions {
    display: flex;
    gap: 0.5rem;
}

.file-btn {
    padding: 0.25rem 0.5rem;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
}

.file-btn.delete {
    background: #dc3545;
    color: white;
}

.file-btn.delete:hover {
    background: #c82333;
}

.no-files-message {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.no-files-message h4 {
    color: #856404;
    margin-bottom: 1rem;
}

.no-files-message p {
    margin-bottom: 0.5rem;
    color: #856404;
}

.no-files-message ol {
    margin: 0.5rem 0 0.5rem 1.5rem;
    color: #856404;
}

.files-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}

.files-info h4 {
    color: #0c5460;
    margin-bottom: 0.5rem;
}

.files-info ul {
    margin: 0.5rem 0 0 1.5rem;
    color: #0c5460;
}

.success-summary {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.success-summary h4 {
    color: #155724;
    margin-bottom: 1rem;
}

.process-summary {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 5px;
    margin: 1rem 0;
    border-left: 4px solid #28a745;
}

.process-summary ul {
    margin: 0.5rem 0 0 1.5rem;
    color: #155724;
}

.detailed-results {
    margin-top: 1rem;
}

.detailed-results h5 {
    color: #155724;
    margin-bottom: 0.5rem;
}

.detailed-results ul {
    margin: 0.5rem 0 0 1rem;
}

.wiki-success {
    background: #e7f3ff;
    padding: 0.75rem;
    border-radius: 5px;
    margin-bottom: 0.5rem;
    border-left: 4px solid #007bff;
}

.wiki-success a {
    color: #007bff;
    text-decoration: none;
    font-weight: bold;
}

.wiki-success a:hover {
    text-decoration: underline;
}

.error-item {
    background: #f8d7da;
    padding: 0.5rem;
    border-radius: 5px;
    margin-bottom: 0.25rem;
    border-left: 4px solid #dc3545;
    color: #721c24;
}

.skipped-item {
    background: #fff3cd;
    padding: 0.5rem;
    border-radius: 5px;
    margin-bottom: 0.25rem;
    border-left: 4px solid #ffc107;
    color: #856404;
}


</style>

<script>
let currentTaskId = null;
let statusInterval = null;

// Load system status on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshSystemStatus();
});

// Refresh system status
async function refreshSystemStatus() {
    console.log('üîç Refreshing system status...');
    try {
        const response = await fetch('/admin/api/system/status');
        const data = await response.json();
        
        // Update Ollama status
        const ollamaCard = document.getElementById('ollamaStatus');
        const ollamaText = ollamaCard.querySelector('.status-text');
        if (data.ollama.status === 'connected') {
            ollamaText.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi';
            ollamaText.style.color = '#28a745';
        } else {
            ollamaText.textContent = '‚ùå Ch∆∞a k·∫øt n·ªëi';
            ollamaText.style.color = '#dc3545';
        }
        

        
    } catch (error) {
        console.error('Error refreshing status:', error);
    }
}

// Handle crawler form submission
document.getElementById('crawlerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const startBtn = document.getElementById('startCrawlerBtn');
    
    // Validate URLs
    const urls = formData.get('urls').trim();
    const urlList = urls.split('\n').filter(url => url.trim());
    
    if (urlList.length < 1) {
        alert('C·∫ßn √≠t nh·∫•t 1 URL ƒë·ªÉ thu th·∫≠p!');
        return;
    }
    
    if (urlList.length > 5) {
        alert('T·ªëi ƒëa 5 URL m·ªói l·∫ßn!');
        return;
    }
    
    // Validate URL format
    for (let url of urlList) {
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            alert(`URL kh√¥ng h·ª£p l·ªá: ${url}`);
            return;
        }
    }
    
    // Start crawler
    startBtn.textContent = '‚è≥ ƒêang kh·ªüi ƒë·ªông...';
    startBtn.disabled = true;
    
    try {
        const response = await fetch('/admin/api/crawler/start', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            currentTaskId = result.task_id;
            showTaskMonitor(result.task_id);
            startStatusPolling();
            
            // Reset form
            this.reset();
        } else {
            alert(`L·ªói: ${result.error}`);
        }
        
    } catch (error) {
        alert(`L·ªói k·∫øt n·ªëi: ${error.message}`);
    } finally {
        startBtn.textContent = 'üöÄ B·∫Øt ƒë·∫ßu thu th·∫≠p';
        startBtn.disabled = false;
    }
});

// Show task monitor
function showTaskMonitor(taskId) {
    currentTaskId = taskId;
    document.getElementById('currentTaskId').textContent = taskId;
    document.getElementById('currentTaskStatus').textContent = 'running';
    document.getElementById('currentTaskStatus').className = 'status-badge running';
    document.getElementById('taskLogs').textContent = 'ƒêang kh·ªüi ƒë·ªông...';
    document.getElementById('taskMonitor').style.display = 'block';
    
    // Scroll to monitor
    document.getElementById('taskMonitor').scrollIntoView({ behavior: 'smooth' });
}

// Hide task monitor
function hideTaskMonitor() {
    document.getElementById('taskMonitor').style.display = 'none';
    if (statusInterval) {
        clearInterval(statusInterval);
        statusInterval = null;
    }
    currentTaskId = null;
}

// Start status polling
function startStatusPolling() {
    if (statusInterval) {
        clearInterval(statusInterval);
    }
    
    statusInterval = setInterval(async () => {
        if (!currentTaskId) return;
        
        try {
            const response = await fetch(`/admin/api/crawler/status/${currentTaskId}`);
            const data = await response.json();
            
            // Update status
            const statusElement = document.getElementById('currentTaskStatus');
            statusElement.textContent = data.status;
            statusElement.className = `status-badge ${data.status}`;
            
            // Update logs
            const logsElement = document.getElementById('taskLogs');
            if (data.logs && data.logs.length > 0) {
                logsElement.textContent = data.logs.join('\n');
                logsElement.scrollTop = logsElement.scrollHeight;
            }
            
            // Stop polling if completed or failed
            if (data.status === 'completed' || data.status === 'failed') {
                clearInterval(statusInterval);
                statusInterval = null;
                
                // Refresh system status
                setTimeout(refreshSystemStatus, 1000);
            }
            
        } catch (error) {
            console.error('Error polling status:', error);
        }
    }, 2000);
}

// Refresh logs manually
async function refreshLogs() {
    if (!currentTaskId) return;
    
    try {
        const response = await fetch(`/admin/api/crawler/logs/${currentTaskId}`);
        const data = await response.json();
        
        const logsElement = document.getElementById('taskLogs');
        if (data.logs && data.logs.length > 0) {
            logsElement.textContent = data.logs.join('\n');
            logsElement.scrollTop = logsElement.scrollHeight;
        }
    } catch (error) {
        console.error('Error refreshing logs:', error);
    }
}

// Handle cleaner form submission
document.getElementById('cleanerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const resultsDiv = document.getElementById('cleanerResults');
    const outputDiv = document.getElementById('cleanerOutput');
    const aiPrompt = document.getElementById('aiPrompt').value.trim();
    
    if (!aiPrompt) {
        alert('Vui l√≤ng nh·∫≠p AI prompt!');
        return;
    }
    
    // Ki·ªÉm tra file raw tr∆∞·ªõc khi x·ª≠ l√Ω
    outputDiv.innerHTML = 'üîç ƒêang ki·ªÉm tra file raw...';
    resultsDiv.style.display = 'block';
    
    try {
        const checkResponse = await fetch('/admin/api/files/raw_content');
        const checkData = await checkResponse.json();
        
        if (!checkResponse.ok) {
            outputDiv.innerHTML = `‚ùå L·ªói ki·ªÉm tra file: ${checkData.error}`;
            return;
        }
        
        const files = checkData.files || [];
        const summaryFiles = files.filter(f => f.name.startsWith('summary_'));
        const regularFiles = files.filter(f => !f.name.startsWith('summary_'));
        
        if (summaryFiles.length === 0 && regularFiles.length === 0) {
            outputDiv.innerHTML = `
                <div class="no-files-message">
                    <h4>üìÇ Kh√¥ng c√≥ file raw ƒë·ªÉ x·ª≠ l√Ω</h4>
                    <p>Th∆∞ m·ª•c <code>raw_content/</code> ƒëang tr·ªëng.</p>
                    <p><strong>H∆∞·ªõng d·∫´n:</strong></p>
                    <ol>
                        <li>S·ª≠ d·ª•ng <strong>Multi-Source Crawler</strong> ƒë·ªÉ thu th·∫≠p n·ªôi dung tr∆∞·ªõc</li>
                        <li>Sau khi crawler ho√†n t·∫•t, quay l·∫°i ƒë√¢y ƒë·ªÉ x·ª≠ l√Ω AI</li>
                    </ol>
                    <p>üí° <em>Crawler s·∫Ω t·∫°o file raw t·ª± ƒë·ªông khi thu th·∫≠p xong.</em></p>
                </div>
            `;
            return;
        }
        
        // Hi·ªÉn th·ªã th√¥ng tin file s·∫Ω x·ª≠ l√Ω
        let fileInfo = `<div class="files-info">
            <h4>üìã S·∫Ω x·ª≠ l√Ω ${files.length} file:</h4>
            <ul>`;
        
        if (summaryFiles.length > 0) {
            fileInfo += `<li>üéØ ${summaryFiles.length} file t·ªïng h·ª£p (t·∫°o wiki)</li>`;
        }
        if (regularFiles.length > 0) {
            fileInfo += `<li>üìÑ ${regularFiles.length} file th√¥ng th∆∞·ªùng (l√†m s·∫°ch)</li>`;
        }
        
        fileInfo += `</ul></div>`;
        
        outputDiv.innerHTML = fileInfo + '<p>‚è≥ ƒêang x·ª≠ l√Ω v·ªõi AI...</p>';
        
    } catch (error) {
        outputDiv.innerHTML = `‚ùå L·ªói ki·ªÉm tra file: ${error.message}`;
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('action', 'batch');
        formData.append('custom_prompt', aiPrompt);
        
        const response = await fetch('/admin/api/clean-text', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            let html = `<div class="success-summary">
                <h4>üéâ ${result.message}</h4>
            `;
            
            // Hi·ªÉn th·ªã th·ªëng k√™ t·ªïng quan
            if (result.summary) {
                html += `<div class="process-summary">
                    <p><strong>üìä T·ªïng k·∫øt:</strong></p>
                    <ul>`;
                
                if (result.summary.wiki_created > 0) {
                    html += `<li>üéØ <strong>${result.summary.wiki_created} b√†i wiki</strong> ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng</li>`;
                }
                if (result.summary.skipped > 0) {
                    html += `<li>‚è≠Ô∏è <strong>${result.summary.skipped} nh√≥m file</strong> ƒë√£ b·ªè qua (ch·ªâ x·ª≠ l√Ω summary)</li>`;
                }
                if (result.summary.failed > 0) {
                    html += `<li>‚ùå <strong>${result.summary.failed} file</strong> x·ª≠ l√Ω th·∫•t b·∫°i</li>`;
                }
                
                html += `</ul></div>`;
            }
            
            // Hi·ªÉn th·ªã chi ti·∫øt t·ª´ng file
            html += `<div class="detailed-results"><h5>üìã Chi ti·∫øt:</h5><ul>`;
            
            result.results.forEach(item => {
                if (item.status === 'success') {
                    if (item.type === 'wiki_created') {
                        html += `<li class="wiki-success">
                            üéØ <strong>Wiki t·∫°o th√†nh c√¥ng:</strong> "${item.wiki_title}"<br>
                            üìÑ T·ª´ ${item.sources_count} ngu·ªìn | Ph∆∞∆°ng ph√°p: ${item.method}<br>
                            üîó <a href="${item.wiki_url}" target="_blank">Xem b√†i vi·∫øt</a>
                        </li>`;
                    } else {
                        html += `<li>‚úÖ ${item.input} ‚Üí ${item.output}</li>`;
                    }
                } else if (item.status === 'skipped') {
                    html += `<li class="skipped-item">‚è≠Ô∏è ${item.input}: ${item.output}</li>`;
                } else {
                    html += `<li class="error-item">‚ùå ${item.input}: ${item.error}</li>`;
                }
            });
            
            html += '</ul></div></div>';
            outputDiv.innerHTML = html;
            
            // Refresh system status
            setTimeout(refreshSystemStatus, 1000);
        } else {
            outputDiv.innerHTML = `‚ùå L·ªói: ${result.error}`;
        }
        
    } catch (error) {
        outputDiv.innerHTML = `‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`;
    }
});

// Reset prompt to default
function resetPrompt() {
    const defaultPrompt = `B·∫°n l√† chuy√™n gia vi·∫øt b√†i v·ªÅ n√¥ng nghi·ªáp. H√£y t·ªïng h·ª£p v√† vi·∫øt l·∫°i n·ªôi dung sau th√†nh m·ªôt b√†i vi·∫øt wiki ho√†n ch·ªânh.

Y√äU C·∫¶U:
1. T·∫°o m·ªôt b√†i vi·∫øt m·∫°ch l·∫°c, c√≥ c·∫•u tr√∫c r√µ r√†ng
2. Lo·∫°i b·ªè th√¥ng tin tr√πng l·∫∑p gi·ªØa c√°c ngu·ªìn
3. T·ªïng h·ª£p th√¥ng tin t·ª´ nhi·ªÅu ngu·ªìn th√†nh n·ªôi dung th·ªëng nh·∫•t
4. S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng Markdown v·ªõi ti√™u ƒë·ªÅ, danh s√°ch, b·∫£ng bi·ªÉu
5. Gi·ªØ l·∫°i th√¥ng tin quan tr·ªçng, lo·∫°i b·ªè qu·∫£ng c√°o
6. Vi·∫øt b·∫±ng ti·∫øng Vi·ªát, phong c√°ch wiki chuy√™n nghi·ªáp
7. Th√™m c√°c ph·∫ßn: Gi·ªõi thi·ªáu, N·ªôi dung ch√≠nh, K·∫øt lu·∫≠n

N·ªòI DUNG C·∫¶N X·ª¨ L√ù:
{content}

B√ÄI VI·∫æT WIKI HO√ÄN CH·ªàNH:`;
    
    document.getElementById('aiPrompt').value = defaultPrompt;
}

// Check raw files
async function checkRawFiles() {
    const resultsDiv = document.getElementById('cleanerResults');
    const outputDiv = document.getElementById('cleanerOutput');
    
    outputDiv.innerHTML = 'üîç ƒêang ki·ªÉm tra file raw...';
    resultsDiv.style.display = 'block';
    
    try {
        const response = await fetch('/admin/api/files/raw_content');
        const data = await response.json();
        
        if (!response.ok) {
            outputDiv.innerHTML = `‚ùå L·ªói: ${data.error}`;
            return;
        }
        
        const files = data.files || [];
        const summaryFiles = files.filter(f => f.name.startsWith('summary_'));
        const regularFiles = files.filter(f => !f.name.startsWith('summary_'));
        
        if (files.length === 0) {
            outputDiv.innerHTML = `
                <div class="no-files-message">
                    <h4>üìÇ Th∆∞ m·ª•c raw_content tr·ªëng</h4>
                    <p>Ch∆∞a c√≥ file n√†o ƒë·ªÉ x·ª≠ l√Ω.</p>
                    <p><strong>H∆∞·ªõng d·∫´n:</strong></p>
                    <ol>
                        <li>S·ª≠ d·ª•ng <strong>Multi-Source Crawler</strong> ƒë·ªÉ thu th·∫≠p n·ªôi dung</li>
                        <li>Sau khi crawler ho√†n t·∫•t, file raw s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y</li>
                    </ol>
                </div>
            `;
            return;
        }
        
        let html = `<div class="files-info">
            <h4>üìã File raw hi·ªán c√≥ (${files.length} file):</h4>
        `;
        
        if (summaryFiles.length > 0) {
            html += `<h5>üéØ File t·ªïng h·ª£p (${summaryFiles.length}):</h5><ul>`;
            summaryFiles.forEach(file => {
                const sizeKB = (file.size / 1024).toFixed(1);
                html += `<li>üìÑ ${file.name} (${sizeKB} KB - ${file.modified})</li>`;
            });
            html += '</ul>';
        }
        
        if (regularFiles.length > 0) {
            html += `<h5>üìÑ File th√¥ng th∆∞·ªùng (${regularFiles.length}):</h5><ul>`;
            regularFiles.forEach(file => {
                const sizeKB = (file.size / 1024).toFixed(1);
                html += `<li>üìÑ ${file.name} (${sizeKB} KB - ${file.modified})</li>`;
            });
            html += '</ul>';
        }
        
        html += `</div>
            <p><strong>üí° S·∫µn s√†ng x·ª≠ l√Ω:</strong> S·ª≠ d·ª•ng n√∫t "L√†m s·∫°ch v·ªõi prompt t√πy ch·ªânh" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
        `;
        
        outputDiv.innerHTML = html;
        
    } catch (error) {
        outputDiv.innerHTML = `‚ùå L·ªói ki·ªÉm tra file: ${error.message}`;
    }
}

// Clear form
function clearForm() {
    document.getElementById('crawlerForm').reset();
}

// Quick actions
function viewAllPages() {
    window.location.href = '/admin/dashboard';
}

// File viewer functions
let currentFileType = '';

function viewRawContent() {
    currentFileType = 'raw_content';
    showFileViewer('üìÅ File Raw Content', 'raw_content');
}

function viewCleanedContent() {
    currentFileType = 'cleaned_content';
    showFileViewer('üìÅ File Cleaned Content', 'cleaned_content');
}

async function showFileViewer(title, type) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('fileViewerModal').style.display = 'block';
    document.getElementById('deleteAllBtn').style.display = 'block';
    
    // Load file list
    await loadFileList(type);
}

async function loadFileList(type) {
    const fileListDiv = document.getElementById('fileList');
    fileListDiv.innerHTML = '‚è≥ ƒêang t·∫£i danh s√°ch file...';
    
    try {
        const response = await fetch(`/admin/api/files/${type}`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'L·ªói t·∫£i file');
        }
        
        const files = data.files || [];
        
        if (files.length === 0) {
            fileListDiv.innerHTML = `<p>üìÇ Th∆∞ m·ª•c ${type} tr·ªëng</p>`;
            document.getElementById('deleteAllBtn').style.display = 'none';
            return;
        }
        
        // Show file list
        let html = `
            <div class="file-summary">
                <p><strong>üìä T·ªïng c·ªông: ${files.length} file</strong></p>
            </div>
        `;
        
        files.forEach(file => {
            const sizeKB = (file.size / 1024).toFixed(1);
            html += `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-name">üìÑ ${file.name}</div>
                        <div class="file-meta">
                            üìè ${sizeKB} KB ‚Ä¢ üïí ${file.modified}
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="file-btn delete" onclick="deleteSingleFile('${type}', '${file.name}')">
                            üóëÔ∏è X√≥a
                        </button>
                    </div>
                </div>
            `;
        });
        
        fileListDiv.innerHTML = html;
        document.getElementById('deleteAllBtn').style.display = 'block';
        
    } catch (error) {
        fileListDiv.innerHTML = `‚ùå L·ªói t·∫£i danh s√°ch: ${error.message}`;
        document.getElementById('deleteAllBtn').style.display = 'none';
    }
}

function closeFileViewer() {
    document.getElementById('fileViewerModal').style.display = 'none';
    currentFileType = '';
}

async function deleteSingleFile(folder, filename) {
    if (!confirm(`‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a file "${filename}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/api/files/${folder}/${encodeURIComponent(filename)}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ ƒê√£ x√≥a file "${filename}" th√†nh c√¥ng!`);
            // Reload file list
            await loadFileList(folder);
            // Refresh system status
            refreshSystemStatus();
        } else {
            alert(`‚ùå L·ªói: ${result.error}`);
        }
        
    } catch (error) {
        alert(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`);
    }
}

async function deleteAllFiles() {
    if (!currentFileType) return;
    
    const typeNames = {
        'raw_content': 'file raw content',
        'cleaned_content': 'file cleaned content'
    };
    
    if (!confirm(`‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ ${typeNames[currentFileType]}?`)) {
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('target', currentFileType);
        
        const response = await fetch('/admin/api/cleanup', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ ${typeNames[currentFileType]} th√†nh c√¥ng!`);
            closeFileViewer();
            refreshSystemStatus();
        } else {
            alert(`‚ùå L·ªói: ${result.error}`);
        }
        
    } catch (error) {
        alert(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`);
    }
}


</script>
{% endblock %}