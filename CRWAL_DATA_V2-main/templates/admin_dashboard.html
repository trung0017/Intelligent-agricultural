{% extends "base.html" %}

{% block title %}Dashboard Admin - WikiNongSan{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Dashboard Qu·∫£n tr·ªã vi√™n</h1>
    <div class="admin-actions">
        <a href="/admin/create" class="btn btn-primary">+ T·∫°o trang m·ªõi</a>
        <a href="/admin/crawler" class="btn btn-primary">üï∑Ô∏è Crawler & AI</a>
        <a href="/" class="btn btn-secondary">Xem trang ch·ªß</a>
    </div>
</div>

<div class="admin-stats">
    <div class="stat-card">
        <h3>{{ pages|length }}</h3>
        <p>T·ªïng s·ªë trang</p>
    </div>
    <div class="stat-card">
        <h3>1</h3>
        <p>Admin ƒëang ho·∫°t ƒë·ªông</p>
    </div>
    <div class="stat-card">
        <h3>100%</h3>
        <p>H·ªá th·ªëng ho·∫°t ƒë·ªông</p>
    </div>
</div>

<div class="admin-content">
    <div class="admin-section">
        <h2>Qu·∫£n l√Ω trang</h2>
        
        {% if pages %}
        <div class="bulk-actions">
            <button onclick="selectAllPages()" class="btn btn-small">Ch·ªçn t·∫•t c·∫£</button>
            <button onclick="deleteSelectedPages()" class="btn btn-small btn-danger">X√≥a ƒë√£ ch·ªçn</button>
            <button onclick="deleteAllPages()" class="btn btn-small btn-danger">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
            <span id="selectedCount" class="selected-count">0 trang ƒë∆∞·ª£c ch·ªçn</span>
        </div>
        
        <div class="pages-table">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th>Ti√™u ƒë·ªÅ</th>
                        <th>Slug</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    {% for page in pages %}
                    <tr>
                        <td><input type="checkbox" class="page-checkbox" value="{{ page.slug }}" onchange="updateSelectedCount()"></td>
                        <td><a href="/page/{{ page.slug }}">{{ page.title }}</a></td>
                        <td><code>{{ page.slug }}</code></td>
                        <td class="actions">
                            <a href="/page/{{ page.slug }}" class="btn btn-small">Xem</a>
                            <a href="/admin/edit/{{ page.slug }}" class="btn btn-small btn-primary">S·ª≠a</a>
                            <button data-slug="{{ page.slug }}"
                                    class="btn btn-small btn-danger delete-btn">X√≥a</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>Ch∆∞a c√≥ trang n√†o. <a href="/admin/create">T·∫°o trang ƒë·∫ßu ti√™n</a></p>
        </div>
        {% endif %}
    </div>
    

    
    <div class="admin-section">
        <h2>C√¥ng c·ª• h·ªá th·ªëng</h2>
        <div class="tools-grid">
            <div class="tool-card">
                <h4>üï∑Ô∏è Web Crawler</h4>
                <p>Thu th·∫≠p n·ªôi dung t·ª´ nhi·ªÅu trang web v√† t·ªïng h·ª£p b·∫±ng AI</p>
                <a href="/admin/crawler" class="btn btn-small btn-primary">M·ªü Crawler</a>
            </div>
            <div class="tool-card">
                <h4>ü§ñ Text Cleaner</h4>
                <p>L√†m s·∫°ch vƒÉn b·∫£n b·∫±ng AI, t√≠ch h·ª£p trong Crawler</p>
                <a href="/admin/crawler" class="btn btn-small btn-primary">M·ªü AI Tools</a>
            </div>


        </div>
    </div>
</div>

<style>
.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.bulk-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 5px;
    border-left: 4px solid #2c5530;
}

.selected-count {
    font-weight: bold;
    color: #2c5530;
}

.pages-table th:first-child,
.pages-table td:first-child {
    width: 40px;
    text-align: center;
}

.page-checkbox {
    cursor: pointer;
}

#selectAll {
    cursor: pointer;
}
</style>

<script>
async function deletePage(deleteBtn) {
    const slug = deleteBtn.getAttribute('data-slug');
    
    if (!slug) {
        alert('L·ªói: Kh√¥ng t√¨m th·∫•y slug');
        return;
    }
    
    try {

        
        // Hi·ªÉn th·ªã loading
        const originalText = deleteBtn.textContent;
        deleteBtn.textContent = 'X√≥a...';
        deleteBtn.disabled = true;
        
        // G·ªçi API x√≥a
        const response = await fetch(`/admin/delete/${encodeURIComponent(slug)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            // X√≥a row kh·ªèi table lu√¥n, kh√¥ng c·∫ßn reload
            deleteBtn.closest('tr').remove();
            updateSelectedCount();
        } else {
            alert(`L·ªói: ${result.error}`);
            // Kh√¥i ph·ª•c n√∫t
            deleteBtn.textContent = originalText;
            deleteBtn.disabled = false;
        }
        
    } catch (error) {
        alert(`L·ªói k·∫øt n·ªëi: ${error.message}`);
        // Kh√¥i ph·ª•c n√∫t
        const btn = document.querySelector(`[data-slug="${slug}"]`);
        if (btn) {
            btn.textContent = 'X√≥a';
            btn.disabled = false;
        }
    }
}

// Bulk selection functions
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.page-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateSelectedCount();
}

function selectAllPages() {
    const checkboxes = document.querySelectorAll('.page-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    document.getElementById('selectAll').checked = true;
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.page-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = `${count} trang ƒë∆∞·ª£c ch·ªçn`;
    
    // Update select all checkbox
    const allCheckboxes = document.querySelectorAll('.page-checkbox');
    const selectAll = document.getElementById('selectAll');
    selectAll.checked = count === allCheckboxes.length;
    selectAll.indeterminate = count > 0 && count < allCheckboxes.length;
}

async function deleteSelectedPages() {
    const checkboxes = document.querySelectorAll('.page-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Ch·ªçn trang ƒë·ªÉ x√≥a!');
        return;
    }
    
    const slugs = Array.from(checkboxes).map(cb => cb.value);
    let successCount = 0;
    
    // X√≥a t·ª´ng trang
    for (const slug of slugs) {
        try {
            const response = await fetch(`/admin/delete/${slug}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                successCount++;
                // X√≥a row kh·ªèi table
                const checkbox = document.querySelector(`input[value="${slug}"]`);
                if (checkbox) {
                    checkbox.closest('tr').remove();
                }
            }
            
        } catch (error) {
            console.error(`L·ªói x√≥a ${slug}:`, error);
        }
    }
    
    // Reset selections
    document.getElementById('selectAll').checked = false;
    updateSelectedCount();
}



async function deleteAllPages() {
    try {
        const response = await fetch('/admin/delete-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // X√≥a t·∫•t c·∫£ rows kh·ªèi table
            const tbody = document.querySelector('.pages-table tbody');
            if (tbody) {
                tbody.innerHTML = '';
            }
            
            // Reset selections
            document.getElementById('selectAll').checked = false;
            updateSelectedCount();
        } else {
            alert(`L·ªói: ${result.error}`);
        }
        
    } catch (error) {
        alert(`L·ªói k·∫øt n·ªëi: ${error.message}`);
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Delete button event listeners
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-btn')) {
            e.preventDefault();
            deletePage(e.target);
        }
    });
    
    // Th√™m hi·ªáu ·ª©ng cho n√∫t x√≥a
    const deleteButtons = document.querySelectorAll('.btn-danger');
    deleteButtons.forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.05)';
            this.style.transition = 'transform 0.2s';
        });
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
    
    // Initialize selected count
    updateSelectedCount();
    

});
</script>

{% endblock %}